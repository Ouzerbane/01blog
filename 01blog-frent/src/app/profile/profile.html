<div class="profile-container" *ngIf="user">
  <!-- üßë Profile Header -->
  <section class="profile-header">
    <div class="avatar-large" (click)="triggerImagePicker()">
      <img *ngIf="user?.imageUrl; else noImage" [src]="user.imageUrl" />
    </div>

    <ng-template #noImage>
      <div class="avatar-large no-img">
        {{ user.username.charAt(0).toUpperCase()}}
      </div>
    </ng-template>

    <input *ngIf="isuser" type="file" #profileInput accept="image/*" (change)="changeProfileImage($event)" hidden />


    <div class="profile-info">
      <h2>{{ user.username }}</h2>
      <p class="email">{{ user.email }}</p>

      <div class="follow-stats">
        <span (click)="openFollowers()">
          <strong>{{ user.followers }}</strong> Followers
        </span>
        <span (click)="openFollowing()">
          <strong>{{ user.following }}</strong> Following
        </span>
      </div>
    </div>

    <button class="edit-profile-btn" (click)="report()">
      ‚öôÔ∏è Report Profile
    </button>
  </section>

  <!-- üìù User Posts -->
  <section class="user-posts">
    <h3>üìö Posts</h3>

    <div *ngIf="posts.length === 0" class="empty">
      <p>No posts yet.</p>
    </div>

    <div *ngFor="let post of posts" class="post-card">
      <p class="post-author">
        <strong>{{ post.author.username }}</strong>
        <small>{{ post.createdAt | date:'short' }}</small>
      </p>

      <!-- Normal view -->
      <div *ngIf="!post.isEditing; else editMode">
        <h4>{{ post.title }}</h4>
        <p>{{ post.content }}</p>
        <img *ngIf="post.imageUrl" [src]="post.imageUrl" alt="Post image" />

        <div class="post-actions">
          <!-- Like -->
          <button class="action-btn" (click)="likePost(post)">
            <span class="icon" [class.like]="post.like">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="none"
                stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20.8 7.3c0 5.1-8.8 11-8.8 11S3.2 12.4 3.2 7.3A4.6 4.6 0 0 1 7.8 2.7c1.8 0 3.1 1.1 4.2 2.3
                     1.1-1.2 2.4-2.3 4.2-2.3a4.6 4.6 0 0 1 4.6 4.6z" />
              </svg>
            </span>
            <span class="count">{{ post.countLike || 0 }}</span>
          </button>

          <!-- Comments -->
          <button class="action-btn" (click)="toggleComments(post)">
            üí¨ {{ post.countCommets || 0 }}
          </button>

          <!-- Edit/Delete -->
          <button *ngIf="post.canEditAndDelet" class="action-btn" (click)="startEditing(post)">‚úèÔ∏è</button>
          <button *ngIf="post.canEditAndDelet" class="action-btn delete" (click)="deletePost(post)">üóëÔ∏è</button>
        </div>

        <!-- Comments Section -->
        <div *ngIf="post.showComment" class="comment-section">
          <div *ngFor="let comment of post.comment" class="comment-card">
            <p><strong (click)="getProfile(comment.userId)">{{ comment.username }}</strong> <small>{{ comment.createdAt
                | date:'short' }}</small></p>
            <p>{{ comment.content }}</p>
          </div>

          <div class="add-comment">
            <input type="text" [(ngModel)]="post.newComment" placeholder="Write a comment..." />
            <button (click)="addComment(post)">üí¨ Post</button>
          </div>
        </div>
      </div>

      <!-- Edit mode -->
      <ng-template #editMode>
        <div class="edit-form">
          <input type="text" [(ngModel)]="post.editTitle" placeholder="Edit title" />
          <textarea [(ngModel)]="post.editContent" rows="4" placeholder="Edit content"></textarea>

          <!-- üîµ Edit Image -->
          <div class="edit-image-box">
            <label class="upload-label">
              Change Image
              <input type="file" accept="image/*" (change)="onImageSelected($event, post)" hidden />
            </label>

            <img *ngIf="post.previewImage" [src]="post.previewImage" class="preview-image" />
            <img *ngIf="!post.previewImage && post.imageUrl" [src]="post.imageUrl" class="preview-image" />
          </div>

          <div class="edit-actions">
            <button class="save-btn" (click)="savePost(post)">üíæ Save</button>
            <button class="cancel-btn" (click)="cancelEditing(post)">‚ùå Cancel</button>
          </div>
        </div>
      </ng-template>
    </div>
  </section>

  <!-- report  -->
  <div class="report-popup" *ngIf="showReportTemplite">
    <div class="popup-content">
      <h3>Report Profile</h3>
      <input type="text" [(ngModel)]="reportReason" placeholder="Enter your reason..." />
      <button (click)="reportUser()">Send</button>
      <span class="close-btn" (click)="report()">‚úñ</span>
    </div>
  </div>

  <!-- Followers Modal -->
  <div class="modal" *ngIf="showFollowers">
    <div class="modal-content">
      <h3>Followers</h3>
      <div class="suggested-list">
        <div *ngFor="let user of followersList" class="suggested-user">
          <div class="user-info" (click)="getProfile(user.id)">
            <div class="avatar">
              <img *ngIf="user.imageUrl; else fallbackAvatar" [src]="user.imageUrl" alt="{{user.username}}" />
              <ng-template #fallbackAvatar>
                {{ user.username.charAt(0).toUpperCase() }}
              </ng-template>
            </div>
            <span>{{ user.username }}</span>
          </div>
          <button class="follow-btn" [class.following]="user.followed" (click)="toggleFollow(user)">
            {{ user.followed ? 'Following' : 'Follow' }}
          </button>
        </div>
      </div>
      <button class="close-btn" (click)="closeModal()">Close</button>
    </div>
  </div>

  <div class="modal" *ngIf="showFollowing">
    <div class="modal-content">
      <h3>Following</h3>
      <div class="suggested-list">
        <div *ngFor="let user of followingList" class="suggested-user">
          <div class="user-info" (click)="getProfile(user.id)">
            <div class="avatar">
              <img *ngIf="user.imageUrl; else fallbackAvatar2" [src]="user.imageUrl" alt="{{user.username}}" />
              <ng-template #fallbackAvatar2>
                {{ user.username.charAt(0).toUpperCase() }}
              </ng-template>
            </div>
            <span>{{ user.username }}</span>
          </div>
          <button class="follow-btn" [class.following]="user.followed" (click)="toggleFollow(user)">
            {{ user.followed ? 'Following' : 'Follow' }}
          </button>
        </div>
      </div>
      <button class="close-btn" (click)="closeModal()">Close</button>
    </div>
  </div>

</div>